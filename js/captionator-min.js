/* 
	Captionator 0.5b [CaptionCrunch]
	Christopher Giffard, 2011
	Share and enjoy

	https://github.com/cgiffard/Captionator
*/

(function(){var t=10,A=16,E=4.5,F=1.5,J=[0,0,0,0.5],B=!1,c={createDOMException:function(b,c,a){try{document.querySelectorAll("div/[]")}catch(f){var d=function(a,b,c){this.code=a;this.message=b;this.name=c};d.prototype=f;return new d(b,c,a)}},compareArray:function(b,c){if(!(b instanceof Array)||!(c instanceof Array))return!1;if(b.length!==c.length)return!1;for(var a in b)if(b.hasOwnProperty(a)&&b[a]!==c[a])return!1;return!0},generateID:function(b){for(var c="",b=b?b:10;c.length<b;)c+=String.fromCharCode(65+
Math.floor(Math.random()*26));return"captionator"+c},captionify:function(b,e,a){var f=[],d=0,a=a instanceof Object?a:{};if(a.minimumFontSize&&typeof a.minimumFontSize==="number")t=a.minimumFontSize;if(a.minimumLineHeight&&typeof a.minimumLineHeight==="number")A=a.minimumLineHeight;if(a.fontSizeVerticalPercentage&&typeof a.fontSizeVerticalPercentage==="number")E=a.fontSizeVerticalPercentage;if(a.lineHeightRatio&&typeof a.lineHeightRatio!=="number")F=a.lineHeightRatio;if(a.cueBackgroundColour&&a.cueBackgroundColour instanceof
Array)J=a.cueBackgroundColour;if(HTMLVideoElement){if(typeof document.createElement("video").addTextTrack==="function")return!1}else return!1;if(!B){c.TextTrack=function(a,b,e,d,f,o){this.onload=function(){};this.onerror=function(){};this.oncuechange=function(){};this.id=a||"";this.internalMode=c.TextTrack.OFF;this.cues=new c.TextTrackCueList(this);this.activeCues=new c.ActiveTextTrackCueList(this.cues,this);this.kind=b||"subtitles";this.label=e||"";this.language=d||"";this.src=f||"";this.readyState=
c.TextTrack.NONE;this.internalDefault=o||!1;this.getMode=function(){return this.internalMode};this.setMode=function(a){if([c.TextTrack.OFF,c.TextTrack.HIDDEN,c.TextTrack.SHOWING].indexOf(a)!==-1){if(a!==this.internalMode){this.internalMode=a;this.readyState===c.TextTrack.NONE&&this.src.length>0&&a>c.TextTrack.OFF&&this.loadTrack(this.src,null);this.readyState===c.TextTrack.LOADED&&c.rebuildCaptions(this.videoNode);if((a===c.TextTrack.OFF||a===c.TextTrack.HIDDEN)&&this.videoNode.containerObject)try{this.videoNode.containerObject.parentNode.removeChild(this.videoNode.containerObject)}catch(b){}if(a===
c.TextTrack.OFF)this.cues.length=0,this.readyState=c.TextTrack.NONE}}else throw Error("Illegal mode value for track: "+a);};this.getDefault=function(){return this.internalDefault};Object.prototype.__defineGetter__?(this.__defineGetter__("mode",this.getMode),this.__defineSetter__("mode",this.setMode),this.__defineGetter__("default",this.getDefault)):Object.defineProperty&&(Object.defineProperty(this,"mode",{get:this.getMode,set:this.setMode}),Object.defineProperty(this,"default",{get:this.getDefault}));
this.loadTrack=function(a,b){var g,h=new XMLHttpRequest;if(this.readyState===c.TextTrack.LOADED)b instanceof Function&&b(g);else{this.src=a;this.readyState=c.TextTrack.LOADING;var e=this;h.open("GET",a,!0);h.onreadystatechange=function(){if(h.readyState===4)if(h.status===200){var a=e.videoNode._captionatorOptions||{};if(e.kind==="metadata")a.processCueHTML=!1,a.sanitiseCueHTML=!1;g=c.parseCaptions(h.responseText,a);e.readyState=c.TextTrack.LOADED;e.cues.loadCues(g);c.rebuildCaptions(e.videoNode);
e.onload.call(this);b instanceof Function&&b.call(e,g)}else e.readyState=c.TextTrack.ERROR,e.onerror()};try{h.send(null)}catch(d){e.readyState=c.TextTrack.ERROR,e.onerror(d)}}};this.addCue=function(a){if(a&&a instanceof c.TextTrackCue)this.cues.addCue(a);else throw Error("The argument is null or not an instance of TextTrackCue.");};this.removeCue=function(){}};c.TextTrack.NONE=0;c.TextTrack.LOADING=1;c.TextTrack.LOADED=2;c.TextTrack.ERROR=3;c.TextTrack.OFF=0;c.TextTrack.HIDDEN=1;c.TextTrack.SHOWING=
2;c.TextTrackCueList=function(a){this.track=a instanceof c.TextTrack?a:null;this.getCueById=function(a){return this.filter(function(b){return b.id===a})[0]};this.loadCues=function(a){for(var b=0;b<a.length;b++)a[b].track=this.track,Array.prototype.push.call(this,a[b])};this.addCue=function(a){if(a&&a instanceof c.TextTrackCue)if(a.track===this.track||!a.track)Array.prototype.push.call(this,a);else throw Error("This cue is associated with a different track!");else throw Error("The argument is null or not an instance of TextTrackCue.");
};this.toString=function(){return"[TextTrackCueList]"}};c.TextTrackCueList.prototype=[];c.ActiveTextTrackCueList=function(a,b){this.refreshCues=function(){if(a.length){var c=this,e=!1,d=[].slice.call(this,0);this.length=0;a.forEach(function(a){a.active&&(c.push(a),c[c.length-1]!==d[c.length-1]&&(e=!0))});if(e)try{b.oncuechange()}catch(f){}}};this.toString=function(){return"[ActiveTextTrackCueList]"};this.refreshCues()};c.ActiveTextTrackCueList.prototype=new c.TextTrackCueList(null);c.TextTrackCue=
function(a,b,e,d,f,o,p){this.id=a;this.track=p instanceof c.TextTrack?p:null;this.startTime=parseFloat(b);this.endTime=parseFloat(e);this.text=typeof d==="string"||d instanceof c.CaptionatorCueStructure?d:"";this.settings=typeof f==="string"?f:"";this.intSettings={};this.pauseOnExit=!!o;this.wasActive=!1;this.direction="horizontal";this.snapToLines=!0;this.linePosition="auto";this.textPosition=50;this.size=100;this.alignment="middle";if(this.settings.length){var r=this.intSettings,s=this,f=f.split(/\s+/).filter(function(a){return a.length>
0});f instanceof Array&&f.forEach(function(a){var b={D:"direction",L:"linePosition",T:"textPosition",A:"alignment",S:"size"},a=a.split(":");b[a[0]]&&(r[b[a[0]]]=a[1]);b[a[0]]in s&&(s[b[a[0]]]=a[1])})}if(this.linePosition.match(/\%/))this.snapToLines=!1;this.getCueAsSource=function(){return String(this.text)};this.getCueAsHTML=function(){var a=document.createDocumentFragment(),b=document.createElement("div");b.innerHTML=String(this.text);Array.prototype.forEach.call(b.childNodes,function(b){a.appendChild(b.cloneNode(!0))});
return a};this.isActive=function(){var a=0;if(this.track instanceof c.TextTrack&&this.track.mode===c.TextTrack.SHOWING&&this.track.readyState===c.TextTrack.LOADED)try{if(a=this.track.videoNode.currentTime,this.startTime<=a&&this.endTime>=a){if(!this.wasActive)this.wasActive=!0,this.onenter();return!0}}catch(b){return!1}if(this.wasActive)this.wasActive=!1,this.onexit();return!1};Object.prototype.__defineGetter__?this.__defineGetter__("active",this.isActive):Object.defineProperty&&Object.defineProperty(this,
"active",{get:this.isActive});this.toString=function(){return"TextTrackCue:"+this.id+"\n"+String(this.text)};this.onenter=function(){};this.onexit=function(){}};c.MediaTrack=function(a,b,e,d,f,o){var p=function(a){return a.filter(function(a){try{var b=document.createElement(a.getAttribute("type").split("/").shift());return!(!b.canPlayType||!b.canPlayType(a.getAttribute("type")).replace(/no/,""))}catch(c){return!1}}).shift().getAttribute("src")};this.onload=function(){};this.onerror=function(){};this.id=
a||"";this.internalMode=this.internalMode=c.TextTrack.OFF;this.mediaElement=null;this.kind=b||"audiodescription";this.label=e||"";this.language=d||"";this.readyState=c.TextTrack.NONE;this.type=o||"x/unknown";this.mediaType=null;this.src="";if(typeof f==="string")this.src=f;else if(f instanceof NodeList)this.src=p(f);if(this.type.match(/^video\//))this.mediaType="video";else if(this.type.match(/^audio\//))this.mediaType="audio";this.getMode=function(){return this.internalMode};this.setMode=function(a){if([c.TextTrack.OFF,
c.TextTrack.HIDDEN,c.TextTrack.SHOWING].indexOf(a)!==-1){if(a!==this.internalMode)this.internalMode=a,a===c.TextTrack.HIDDEN&&!this.mediaElement&&this.buildMediaElement(),a===c.TextTrack.SHOWING&&this.showMediaElement(),(a===c.TextTrack.OFF||a===c.TextTrack.HIDDEN)&&this.hideMediaElement()}else throw Error("Illegal mode value for track.");};Object.prototype.__defineGetter__?(this.__defineGetter__("mode",this.getMode),this.__defineSetter__("mode",this.setMode)):Object.defineProperty&&Object.defineProperty(this,
"mode",{get:this.getMode,set:this.setMode});this.hideMediaElement=function(){if(this.mediaElement&&(this.mediaElement.paused||this.mediaElement.pause(),this.mediaElement instanceof HTMLVideoElement))this.mediaElement.style.display="none"};this.showMediaElement=function(){if(this.mediaElement){if(this.mediaElement.parentNode||document.body.appendChild(this.mediaElement),this.mediaElement instanceof HTMLVideoElement)this.mediaElement.style.display="block"}else this.buildMediaElement(),document.body.appendChild(this.mediaElement)};
this.buildMediaElement=function(){try{if(this.type.match(/^video\//))this.mediaElement=document.createElement("video"),this.mediaElement.className="captionator-mediaElement-"+this.kind,c.styleNode(this.mediaElement,this.kind,this.videoNode);else if(this.type.match(/^audio\//))this.mediaElement=new Audio;this.mediaElement.type=this.type;this.mediaElement.src=this.src;this.mediaElement.load();this.mediaElement.trackObject=this;this.readyState=c.TextTrack.LOADING;var a=this.mediaElement;this.mediaElement.addEventListener("progress",
function(){a.trackObject.readyState=c.TextTrack.LOADING},!1);this.mediaElement.addEventListener("canplaythrough",function(){a.trackObject.readyState=c.TextTrack.LOADED;a.trackObject.onload.call(a.trackObject)},!1);this.mediaElement.addEventListener("error",function(b){a.trackObject.readyState=c.TextTrack.ERROR;a.trackObject.mode=c.TextTrack.OFF;a.trackObject.mediaElement=null;a.trackObject.onerror.call(a.trackObject,b)},!1)}catch(b){this.readyState=c.TextTrack.ERROR,this.mode=c.TextTrack.OFF,this.mediaElement=
null,this.onerror&&this.onerror.apply(this,b)}}};c.CaptionatorCueStructure=function(a,b){var c=this;this.isTimeDependent=!1;this.cueSource=a;this.options=b;this.processedCue=null;this.toString=function(e){if(b.processCueHTML!==!1){var d=function(a,b){if(c.processedCue===null){var f="",g,h;for(g in a)if(g.match(/^\d+$/)&&a.hasOwnProperty(g))if(h=a[g],h instanceof Object&&h.children&&h.children.length)if(h.token==="v")f+='<q data-voice="'+h.voice.replace(/[\"]/g,"")+"\" class='voice speaker-"+h.voice.replace(/[^a-z0-9]+/ig,
"-").toLowerCase()+"' title=\""+h.voice.replace(/[\"]/g,"")+'">'+d(h.children,b+1)+"</q>";else if(h.token==="c")f+="<span class='webvtt-class-span "+h.classes.join(" ")+"'>"+d(h.children,b+1)+"</span>";else if(h.timeIn>0){if(e===null||e===void 0||e>0&&e>=h.timeIn)f+="<span class='webvtt-timestamp-span' data-timestamp='"+h.token+"' data-timestamp-seconds='"+h.timeIn+"'>"+d(h.children,b+1)+"</span>"}else f+=h.rawToken+d(h.children,b+1)+"</"+h.token+">";else if(h instanceof String||typeof h==="string"||
typeof h==="number")f+=h;if(!c.isTimeDependent&&b===0)c.processedCue=f;return f}else return c.processedCue};return d(this,0)}else return a}};c.CaptionatorCueStructure.prototype=[];if(a.exportObjects)window.TextTrack=c.TextTrack,window.TextTrackCueList=c.TextTrackCueList,window.ActiveTextTrackCueList=c.ActiveTextTrackCueList,window.TextTrackCue=c.TextTrackCue,window.MediaTrack=c.MediaTrack;B=!0}[].slice.call(document.getElementsByTagName("video"),0).forEach(function(a){a.addTextTrack=function(b,e,
d,f,o,p,r){var s="subtitles,captions,descriptions,captions,metadata,karaoke,lyrics,tickertext,audiodescription,commentary,alternate,signlanguage".split(","),h=s.slice(0,7),b=typeof b==="string"?b:"",d=typeof d==="string"?d:"",f=typeof f==="string"?f:"",r=typeof r==="boolean"?r:!1;if(!s.filter(function(a){return e===a?!0:!1}).length)throw c.createDOMException(12,"DOMException 12: SYNTAX_ERR: You must use a valid kind when creating a TimedTextTrack.","SYNTAX_ERR");if(h.filter(function(a){return e===
a?!0:!1}).length)if(b=new c.TextTrack(b,e,d,f,o,null)){if(!(a.tracks instanceof Array))a.tracks=[];a.tracks.push(b);return b}else return!1;else if(b=new c.MediaTrack(b,e,d,f,o,p,r)){if(!(a.mediaTracks instanceof Array))a.mediaTracks=[];a.mediaTracks.push(b);return b}else return!1}});if(!b||b===!1||b===void 0||b===null)f=[].slice.call(document.getElementsByTagName("video"),0);else if(b instanceof Array)for(d=0;d<b.length;d++)typeof b[d]==="string"?f=f.concat([].slice.call(document.querySelectorAll(b[d]),
0)):b[d].constructor===HTMLVideoElement&&f.push(b[d]);else typeof b==="string"?f=[].slice.call(document.querySelectorAll(b),0):b.constructor===HTMLVideoElement&&f.push(b);if(f.length){for(d=0;d<f.length;d++)c.processVideoElement(f[d],e,a);return!0}else return!1},processVideoElement:function(b,e,a){var f=[],d=navigator.language||navigator.userLanguage;e||d.split("-");a=a instanceof Object?a:{};if(!b.captioned){b._captionatorOptions=a;b.className+=(b.className.length?" ":"")+"captioned";b.captioned=
!0;if(b.id.length===0)b.id=c.generateID();[].slice.call(b.querySelectorAll("track"),0).forEach(function(d){var g=null,g=d.querySelectorAll("source").length>0?d.querySelectorAll("source"):d.getAttribute("src"),g=b.addTextTrack(d.getAttribute("id")||c.generateID(),d.getAttribute("kind"),d.getAttribute("label"),d.getAttribute("srclang").split("-")[0],g,d.getAttribute("type"),d.hasAttribute("default"));d.track=g;g.trackNode=d;g.videoNode=b;f.push(g);var k=!1;if((g.kind==="subtitles"||g.kind==="captions")&&
e===g.language&&a.enableCaptionsByDefault)f.filter(function(a){return(a.kind==="captions"||a.kind==="subtitles")&&e===a.language&&a.mode===c.TextTrack.SHOWING?!0:!1}).length||(k=!0);g.kind==="chapters"&&e===g.language&&(f.filter(function(a){return a.kind==="chapters"&&a.mode===c.TextTrack.SHOWING?!0:!1}).length||(k=!0));g.kind==="descriptions"&&a.enableDescriptionsByDefault===!0&&e===g.language&&(f.filter(function(a){return a.kind==="descriptions"&&a.mode===c.TextTrack.SHOWING?!0:!1}).length||(k=
!0));k===!0&&f.forEach(function(a){if(a.trackNode.hasAttribute("default")&&a.mode===c.TextTrack.SHOWING)a.mode=c.TextTrack.HIDDEN});if(d.hasAttribute("default")&&!f.filter(function(a){return a.trackNode.hasAttribute("default")&&a.trackNode!==d?!0:!1}).length)k=!0,g.internalDefault=!0;if(k===!0)g.mode=c.TextTrack.SHOWING});b.addEventListener("timeupdate",function(b){b=b.target;try{b.tracks.forEach(function(a){a.activeCues.refreshCues.apply(a.activeCues)})}catch(e){}a.renderer instanceof Function?a.renderer.call(c,
b):c.rebuildCaptions(b);c.synchroniseMediaElements(b)},!1);b.addEventListener("play",function(){c.synchroniseMediaElements(b)},!1);b.addEventListener("pause",function(){c.synchroniseMediaElements(b)},!1)}return b},rebuildCaptions:function(b){var e=b.currentTime,a=[],f=!1,d=[],l=[];(b.tracks||[]).forEach(function(b){b.mode===c.TextTrack.SHOWING&&b.readyState===c.TextTrack.LOADED&&(l=[].slice.call(b.activeCues,0),l=l.sort(function(a,b){return a.startTime>b.startTime?-1:1}),a=a.concat(l))});d=a.map(function(a){return a.track.id+
"."+a.id+":"+a.text.toString(e).length});if(f=!c.compareArray(d,b._captionator_previousActiveCues))b._captionator_availableCueArea=null,b._captionator_previousActiveCues=d,c.styleCueCanvas(b),b._containerObject.innerHTML="",a.forEach(function(a){var d=document.createElement("div");d.id=String(a.id).length?a.id:c.generateID();d.className="captionator-cue";d.innerHTML=a.text.toString(e);b._containerObject.appendChild(d);c.styleCue(d,a,b)})},synchroniseMediaElements:function(b){var e=function(a,b){try{b.seeking&&
a.pause();if(a.currentTime<b.currentTime-0.5||a.currentTime>b.currentTime+0.5)a.currentTime=b.currentTime;a.paused&&!b.paused?a.play():!a.paused&&b.paused&&a.pause()}catch(c){}};(b.mediaTracks||[]).forEach(function(a){a.mode===c.TextTrack.SHOWING&&a.readyState>=c.TextTrack.LOADING&&e(a.mediaElement,b)});b.id&&[].slice.call(document.body.querySelectorAll("*[syncMaster="+b.id+"]"),0).forEach(function(a){(a.tagName.toLowerCase()==="video"||a.tagName.toLowerCase()==="audio")&&e(a,b)})},getNodeMetrics:function(b){for(var c=
window.getComputedStyle(b,null),a=b,f=b.offsetTop,d=b.offsetLeft,l=b,g=0,k=0,l=parseInt(c.getPropertyValue("width"),10),g=parseInt(c.getPropertyValue("height"),10);a=a.offsetParent;)f+=a.offsetTop,d+=a.offsetLeft;if(b.hasAttribute("controls"))b=navigator.userAgent.toLowerCase(),b.indexOf("chrome")!==-1?k=32:b.indexOf("opera")!==-1?k=25:b.indexOf("firefox")!==-1?k=28:b.indexOf("ie 9")!==-1||b.indexOf("ipad")!==-1?k=44:b.indexOf("safari")!==-1&&(k=25);else if(b._captionatorOptions)b=b._captionatorOptions,
b.controlHeight&&(k=parseInt(b.controlHeight,10));return{left:d,top:f,width:l,height:g,controlHeight:k}},applyStyles:function(b,c){for(var a in c)({}).hasOwnProperty.call(c,a)&&(b.style[a]=c[a])},checkDirection:function(b){var c=RegExp("^[^\u0591-\u07ff\ufb1d-\ufdfd\ufe70-\ufefc]*[A-Za-z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u02b8\u0300-\u0590\u0800-\u1fff\u2c00-\ufb1c\ufdfe-\ufe6f\ufefd-\uffff]");return RegExp("^[^A-Za-z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u02b8\u0300-\u0590\u0800-\u1fff\u2c00-\ufb1c\ufdfe-\ufe6f\ufefd-\uffff]*[\u0591-\u07ff\ufb1d-\ufdfd\ufe70-\ufefc]").test(b)?
"rtl":c.test(b)?"ltr":""},styleCue:function(b,e,a){var f=0,d=0,l=0,g=0,k,v,G=0,o=0,p,r,s,h,q,m,C=0,w=k=d=0,i=0,H=0,x=0,y,D,z=0,i=a._captionatorOptions||{},j,B=function(a){var b=function(a){return!!a.length},d,e,f,h,g=0,i=function(a){g++;c.applyStyles(a,{display:"block",lineHeight:"auto",height:p+"px",width:m+"px",textAlign:"center"})};for(d in a.childNodes)if(a.childNodes.hasOwnProperty(d))e=a.childNodes[d],e.nodeType===3?(h=document.createDocumentFragment(),f=e.nodeValue,h.appendChild(document.createElement("span")),
h.childNodes[0].innerHTML="<span class='captionator-cue-character'>"+f.split(/(.)/).filter(b).join("</span><span class='captionator-cue-character'>")+"</span>",[].slice.call(h.querySelectorAll("span.captionator-cue-character"),0).forEach(i),e.parentNode.replaceChild(h,e)):a.childNodes[d].nodeType===1&&(g+=B(a.childNodes[d]));return g};j=c.getNodeMetrics(a);if(!a._captionator_availableCueArea)a._captionator_availableCueArea={bottom:j.height-j.controlHeight,right:j.width,top:0,left:0,height:j.height-
j.controlHeight,width:j.width};d=j.height*(E/100)/96*72;d=d>=t?d:t;p=Math.floor(d/72*96);r=Math.floor(d*F);r=r>A?r:A;m=q=Math.ceil(r/72*96);q*Math.floor(j.height/q)<j.height&&(q=Math.floor(j.height/Math.floor(j.height/q)),r=Math.ceil(q/96*72));q*Math.floor(j.width/q)<j.width&&(m=Math.ceil(j.width/Math.floor(j.width/q)));s=Math.floor(a._captionator_availableCueArea.height/q);h=Math.floor(a._captionator_availableCueArea.width/m);k=parseFloat(String(e.size).replace(/[^\d\.]/ig,""));k=k<=100?k:100;G=
e.direction==="horizontal"?Math.floor(j.width*0.01):0;o=e.direction==="horizontal"?0:Math.floor(j.height*0.01);if(e.linePosition==="auto")e.linePosition=e.direction==="horizontal"?s:h;else if(String(e.linePosition).match(/\%/))e.snapToLines=!1,e.linePosition=parseFloat(String(e.linePosition).replace(/\%/ig,""));e.direction==="horizontal"?(g=q,l=e.snapToLines===!0?a._captionator_availableCueArea.width*(k/100):j.width*(k/100),e.textPosition==="auto"?f=(a._captionator_availableCueArea.right-l)/2+a._captionator_availableCueArea.left:
(e.textPosition=parseFloat(String(e.textPosition).replace(/[^\d\.]/ig,"")),f=(a._captionator_availableCueArea.right-l)*(e.textPosition/100)+a._captionator_availableCueArea.left),d=e.snapToLines===!0?(s-1)*q+a._captionator_availableCueArea.top:(j.height-(j.controlHeight+q+o*2))*(e.linePosition/100)):(d=a._captionator_availableCueArea.top,f=a._captionator_availableCueArea.right-m,l=m,g=a._captionator_availableCueArea.height*(k/100),d=B(b),k=[].slice.call(b.querySelectorAll("span.captionator-cue-character"),
0),C=Math.floor((g-o*2)/p),l=Math.ceil(d/C)*m,w=Math.ceil(d/C),H=(d-C*(w-1))*p,e.snapToLines===!0?f=e.direction==="vertical-lr"?a._captionator_availableCueArea.left:a._captionator_availableCueArea.right-l:(d=l+G*2,f=e.direction==="vertical-lr"?(j.width-d)*(e.linePosition/100):j.width-d-(j.width-d)*(e.linePosition/100)),e.textPosition==="auto"?d=(a._captionator_availableCueArea.bottom-g)/2+a._captionator_availableCueArea.top:(e.textPosition=parseFloat(String(e.textPosition).replace(/[^\d\.]/ig,"")),
d=(a._captionator_availableCueArea.bottom-g)*(e.textPosition/100)+a._captionator_availableCueArea.top),D=y=z=x=0,k.forEach(function(a){y=e.direction==="vertical-lr"?m*x:l-m*(x+1);e.alignment==="start"||e.alignment!=="start"&&x<w-1?D=z*p+o:e.alignment==="end"?D=z*p-p+(g+o*2-H):e.alignment==="middle"&&(D=(g-o*2-H)/2+z*p);c.applyStyles(a,{position:"absolute",top:D+"px",left:y+"px"});z>=C-1?(z=0,x++):z++}));e.direction==="horizontal"&&(v=c.checkDirection(String(e.text))==="rtl"?{start:"right",middle:"center",
end:"left"}[e.alignment]:{start:"left",middle:"center",end:"right"}[e.alignment]);c.applyStyles(b,{position:"absolute",overflow:"hidden",width:l+"px",height:g+"px",top:d+"px",left:f+"px",padding:o+"px "+G+"px",textAlign:v,backgroundColor:"rgba("+J.join(",")+")",direction:c.checkDirection(String(e.text)),lineHeight:r+"pt",boxSizing:"border-box"});if(e.direction==="vertical"||e.direction==="vertical-lr")f-a._captionator_availableCueArea.left-a._captionator_availableCueArea.left>=a._captionator_availableCueArea.right-
(f+l)?a._captionator_availableCueArea.right=f:a._captionator_availableCueArea.left=f+l,a._captionator_availableCueArea.width=a._captionator_availableCueArea.right-a._captionator_availableCueArea.left;else{if(b.scrollHeight>b.offsetHeight*1.2){if(e.snapToLines){for(v=0;b.scrollHeight>b.offsetHeight*1.2;)g+=q,b.style.height=g+"px",v++;d-=v*q}else v=b.scrollHeight-g,g=b.scrollHeight+j.height*0.01,d-=v,b.style.height=g+"px";b.style.top=d+"px"}d-a._captionator_availableCueArea.top-a._captionator_availableCueArea.top>=
a._captionator_availableCueArea.bottom-(d+g)?a._captionator_availableCueArea.bottom=d:a._captionator_availableCueArea.top=d+g;a._captionator_availableCueArea.height=a._captionator_availableCueArea.bottom-a._captionator_availableCueArea.top}if(i.debugMode){var u,n,I=function(){if(!u)a._captionatorDebugCanvas?(u=a._captionatorDebugCanvas,n=a._captionatorDebugContext):(u=document.createElement("canvas"),u.setAttribute("width",j.width),u.setAttribute("height",j.height-j.controlHeight),document.body.appendChild(u),
c.applyStyles(u,{position:"absolute",top:j.top+"px",left:j.left+"px",width:j.width+"px",height:j.height-j.controlHeight+"px",zIndex:3E3}),n=u.getContext("2d"),a._captionatorDebugCanvas=u,a._captionatorDebugContext=n)};I();u.setAttribute("width",j.width);I();n.fillStyle="rgba(100,100,255,0.5)";n.fillRect(a._captionator_availableCueArea.left,a._captionator_availableCueArea.top,a._captionator_availableCueArea.right,a._captionator_availableCueArea.bottom);n.stroke();(function(){var b;I();n.strokeStyle=
"rgba(255,0,0,0.5)";n.lineWidth=1;n.beginPath();for(b=0;b<s;b++)n.moveTo(0.5,b*q+0.5),n.lineTo(j.width,b*q+0.5);n.closePath();n.stroke();n.beginPath();n.strokeStyle="rgba(0,255,0,0.5)";for(b=h;b>=0;b--)n.moveTo(j.width-b*m-0.5,-0.5),n.lineTo(j.width-b*m-0.5,j.height);n.closePath();n.stroke();n.beginPath();n.strokeStyle="rgba(255,255,0,0.5)";for(b=0;b<=h;b++)n.moveTo(b*m+0.5,-0.5),n.lineTo(b*m+0.5,j.height);n.stroke();a.linesDrawn=!0})()}},styleCueCanvas:function(b){var e,a,f=b._captionatorOptions instanceof
Object?b._captionatorOptions:{};if(!(b instanceof HTMLVideoElement))throw Error("Cannot style a cue canvas for a non-video node!");if(b._containerObject)a=b._containerObject,e=a.id;if(a)a.parentNode||document.body.appendChild(a);else{a=document.createElement("div");a.className="captionator-cue-canvas";e=c.generateID();a.id=e;if(f.appendCueCanvasTo){var d=null;if(f.appendCueCanvasTo instanceof HTMLElement)d=f.appendCueCanvasTo;else if(typeof f.appendCueCanvasTo==="string")try{var l=document.querySelectorAll(f.appendCueCanvasTo);
if(l.length>0)d=l[0];else throw null;}catch(g){d=document.body,f.appendCueCanvasTo=!1}else d=document.body,f.appendCueCanvasTo=!1;d.appendChild(a)}else document.body.appendChild(a);b._containerObject=a;a.setAttribute("aria-live","polite");a.setAttribute("aria-atomic","true")}String(b.getAttribute("aria-describedby")).indexOf(e)===-1&&(d=b.hasAttribute("aria-describedby")?b.getAttribute("aria-describedby")+" ":"",b.setAttribute("aria-describedby",d+e));d=c.getNodeMetrics(b);b=d.height*(E/100)/96*72;
b=b>=t?b:t;e=Math.floor(b*F);e=e>A?e:A;c.applyStyles(a,{position:"absolute",overflow:"hidden",zIndex:100,height:d.height-d.controlHeight+"px",width:d.width+"px",top:(f.appendCueCanvasTo?0:d.top)+"px",left:(f.appendCueCanvasTo?0:d.left)+"px",color:"white",fontFamily:"Verdana, Helvetica, Arial, sans-serif",fontSize:b+"pt",lineHeight:e+"pt",boxSizing:"border-box"});if(window.navigator.userAgent.toLowerCase().indexOf("chrome/10")>-1)a.style.backgroundColor="rgba(0,0,0,0.01"+Math.random().toString().replace(".",
"")+")"},parseCaptions:function(b,e){var e=e instanceof Object?e:{},a="",f=[],d=/^(\d{2})?:?(\d{2}):(\d{2})\.(\d+)\,(\d{2})?:?(\d{2}):(\d{2})\.(\d+)\s*(.*)/,l=/^(\d+)?:?(\d{2}):(\d{2})\.(\d+)\,(\d+)?:?(\d{2}):(\d{2})\.(\d+)\s*(.*)/,g=/^(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)\s+\-\-\>\s+(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)\s*(.*)/,k=/(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)/,v=/^([\d\.]+)\s+\+([\d\.]+)\s*(.*)/,t=/^\[(\d{2})?:?(\d{2})\:(\d{2})\.(\d{2})\]\s*(.*?)$/i,o=/^DEFAULT(S)?\s+\-\-\>\s+(.*)/,p=/^STYLE(S)?\s+\-\-\>\s+(.*)/,
r=/^COMMENT(S)?\s+\-\-\>\s+(.*)/;if(b){var s=function(a){var b=new c.CaptionatorCueStructure(a,e),d=[],f,g,i,l=[];i=0;var o=function(a){return!!a.replace(/[^a-z0-9]+/ig,"").length},d=a.split(/(<\/?[^>]+>)/ig).filter(function(a){return!!a.replace(/\s*/ig,"")});i=b;for(f in d)if(d.hasOwnProperty(f))if(g=d[f],g.substr(0,1)==="<")if(g.substr(1,1)==="/"){if(a=g.substr(2).split(/[\s>]+/g)[0],l.length>0){g=0;for(i=l.length-1;i>=0;i--){var p=l[i][l[i].length-1];g=i;if(p.token===a)break}i=l[g];l=l.slice(0,
g)}}else{if(g.substr(1).match(k)||g.match(/^<v\s+[^>]+>/i)||g.match(/^<c[a-z0-9\-\_\.]+>/)||g.match(/^<(b|i|u|ruby|rt)>/)||e.sanitiseCueHTML!==!1){a={token:g.replace(/[<\/>]+/ig,"").split(/[\s\.]+/)[0],rawToken:g,children:[]};if(a.token==="v")a.voice=g.match(/^<v\s*([^>]+)>/i)[1];else if(a.token==="c")a.classes=g.replace(/[<\/>\s]+/ig,"").split(/[\.]+/ig).slice(1).filter(o);else if(g=a.rawToken.match(k))b.isTimeDependent=!0,g=g.slice(1),a.timeIn=parseInt((g[0]||0)*3600,10)+parseInt((g[1]||0)*60,10)+
parseInt(g[2]||0,10)+parseFloat("0."+(g[3]||0));i.push(a);l.push(i);i=a.children}}else e.sanitiseCueHTML!==!1&&(g=g.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\&/g,"&amp;")),i.push(g);return b},f=b.replace(/\r\n/g,"\n").replace(/\r/g,"\n");t.exec(b)?(f=f.split(/\n+/g),a="LRC"):f=f.split(/\n\n+/g);return f=f.filter(function(b){return b.match(/^WEBVTT(\s*FILE)?/ig)?(a="WebVTT",!1):b.replace(/\s*/ig,"").length?!0:!1}).map(function(b,f){var m,k,w,i,t,x;if(o.exec(b)||p.exec(b)||r.exec(b))return null;
for(m=a==="LRC"?[b.substr(0,b.indexOf("]")),b.substr(b.indexOf("]")+1)]:b.split(/\n/g);!m[0].replace(/\s+/ig,"").length&&m.length>0;)m.shift();for(x=m[0].match(/^\s*\d+\s*$/ig)?String(m.shift().replace(/\s*/ig,"")):f;0<m.length;){var y=m[0];if((i=g.exec(y))||(i=d.exec(y))||(i=l.exec(y)))i=i.slice(1),k=parseInt((i[0]||0)*3600,10)+parseInt((i[1]||0)*60,10)+parseInt(i[2]||0,10)+parseFloat("0."+(i[3]||0)),w=parseInt((i[4]||0)*3600,10)+parseInt((i[5]||0)*60,10)+parseInt(i[6]||0,10)+parseFloat("0."+(i[7]||
0)),i[8]&&(t=i[8]);else if(i=v.exec(y))i=i.slice(1),k=parseFloat(i[0]),w=k+parseFloat(i[1]),i[2]&&(t=i[2]);m=m.slice(0,0).concat(m.slice(1));break}if(!k&&!w)return null;m=e.processCueHTML===!1?m.join("\n"):s(m.join("\n"));k=new c.TextTrackCue(x,k,w,m,t,!1,null);k.styleData=void 0;return k}).filter(function(a){return a!==null?!0:!1})}else throw Error("Required parameter captionData not supplied.");}};window.captionator=c})();