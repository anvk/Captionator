/*
	Captionator 0.5 [CaptionCrunch]
	Christopher Giffard, 2011
	Share and enjoy

	https://github.com/cgiffard/Captionator
*/

(function(){var A=10,B=16,D=4.5,E=1.5,I=[0,0,0,0.5],J=!1,c={createDOMException:function(b,c,a){try{document.querySelectorAll("div/[]")}catch(d){var e=function(a,b,c){this.code=a;this.message=b;this.name=c};e.prototype=d;return new e(b,c,a)}},compareArray:function(b,c){if(!(b instanceof Array)||!(c instanceof Array))return!1;if(b.length!==c.length)return!1;for(var a in b)if(b.hasOwnProperty(a)&&b[a]!==c[a])return!1;return!0},generateID:function(b){for(var c="",b=b?b:10;c.length<b;)c+=String.fromCharCode(65+
Math.floor(Math.random()*26));return"captionator"+c},captionify:function(b,f,a){var d=[],e=0,a=a instanceof Object?a:{};if(a.minimumFontSize&&typeof a.minimumFontSize==="number")A=a.minimumFontSize;if(a.minimumLineHeight&&typeof a.minimumLineHeight==="number")B=a.minimumLineHeight;if(a.fontSizeVerticalPercentage&&typeof a.fontSizeVerticalPercentage==="number")D=a.fontSizeVerticalPercentage;if(a.lineHeightRatio&&typeof a.lineHeightRatio!=="number")E=a.lineHeightRatio;if(a.cueBackgroundColour&&a.cueBackgroundColour instanceof
Array)I=a.cueBackgroundColour;if(HTMLVideoElement){if(typeof document.createElement("video").addTextTrack==="function")return!1}else return!1;if(!J){c.TextTrack=function(a,b,f,d,e,n){this.onload=function(){};this.onerror=function(){};this.oncuechange=function(){};this.id=a||"";this.internalMode=c.TextTrack.OFF;this.cues=new c.TextTrackCueList(this);this.activeCues=new c.ActiveTextTrackCueList(this.cues,this);this.kind=b||"subtitles";this.label=f||"";this.language=d||"";this.src=e||"";this.readyState=
c.TextTrack.NONE;this.internalDefault=n||!1;this.getMode=function(){return this.internalMode};this.setMode=function(a){if([c.TextTrack.OFF,c.TextTrack.HIDDEN,c.TextTrack.SHOWING].indexOf(a)!==-1){if(a!==this.internalMode&&(this.internalMode=a,this.readyState===c.TextTrack.NONE&&this.src.length>0&&a>c.TextTrack.OFF&&this.loadTrack(this.src,null),this.videoNode._captionator_dirtyBit=!0,c.rebuildCaptions(this.videoNode),a===c.TextTrack.OFF))this.cues.length=0,this.readyState=c.TextTrack.NONE}else throw Error("Illegal mode value for track: "+
a);};this.getDefault=function(){return this.internalDefault};Object.prototype.__defineGetter__?(this.__defineGetter__("mode",this.getMode),this.__defineSetter__("mode",this.setMode),this.__defineGetter__("default",this.getDefault)):Object.defineProperty&&(Object.defineProperty(this,"mode",{get:this.getMode,set:this.setMode}),Object.defineProperty(this,"default",{get:this.getDefault}));this.loadTrack=function(a,b){var h,f=new XMLHttpRequest;if(this.readyState===c.TextTrack.LOADED)b instanceof Function&&
b(h);else{this.src=a;this.readyState=c.TextTrack.LOADING;var d=this;f.open("GET",a,!0);f.onreadystatechange=function(){if(f.readyState===4)if(f.status===200){var a=d.videoNode._captionatorOptions||{};if(d.kind==="metadata")a.processCueHTML=!1,a.sanitiseCueHTML=!1;h=c.parseCaptions(f.responseText,a);d.readyState=c.TextTrack.LOADED;d.cues.loadCues(h);d.activeCues.refreshCues.apply(d.activeCues);d.videoNode._captionator_dirtyBit=!0;c.rebuildCaptions(d.videoNode);d.onload.call(this);b instanceof Function&&
b.call(d,h)}else d.readyState=c.TextTrack.ERROR,d.onerror()};try{f.send(null)}catch(i){d.readyState=c.TextTrack.ERROR,d.onerror(i)}}};this.addCue=function(a){if(a&&a instanceof c.TextTrackCue)this.cues.addCue(a);else throw Error("The argument is null or not an instance of TextTrackCue.");};this.removeCue=function(){}};c.TextTrack.NONE=0;c.TextTrack.LOADING=1;c.TextTrack.LOADED=2;c.TextTrack.ERROR=3;c.TextTrack.OFF=0;c.TextTrack.HIDDEN=1;c.TextTrack.SHOWING=2;c.TextTrackCueList=function(a){this.track=
a instanceof c.TextTrack?a:null;this.getCueById=function(a){return this.filter(function(b){return b.id===a})[0]};this.loadCues=function(a){for(var b=0;b<a.length;b++)a[b].track=this.track,Array.prototype.push.call(this,a[b])};this.addCue=function(a){if(a&&a instanceof c.TextTrackCue)if(a.track===this.track||!a.track)Array.prototype.push.call(this,a);else throw Error("This cue is associated with a different track!");else throw Error("The argument is null or not an instance of TextTrackCue.");};this.toString=
function(){return"[TextTrackCueList]"}};c.TextTrackCueList.prototype=[];c.ActiveTextTrackCueList=function(a,b){this.refreshCues=function(){if(a.length){var c=this,f=!1,d=[].slice.call(this,0);this.length=0;a.forEach(function(a){a.active&&(c.push(a),c[c.length-1]!==d[c.length-1]&&(f=!0))});if(f)try{b.oncuechange()}catch(e){}}};this.toString=function(){return"[ActiveTextTrackCueList]"};this.refreshCues()};c.ActiveTextTrackCueList.prototype=new c.TextTrackCueList(null);c.TextTrackCue=function(a,b,f,
d,e,n,l){this.id=a;this.track=l instanceof c.TextTrack?l:null;this.startTime=parseFloat(b);this.endTime=parseFloat(f);this.text=typeof d==="string"||d instanceof c.CaptionatorCueStructure?d:"";this.settings=typeof e==="string"?e:"";this.intSettings={};this.pauseOnExit=!!n;this.wasActive=!1;this.direction="horizontal";this.snapToLines=!0;this.linePosition="auto";this.textPosition=50;this.size=0;this.alignment="middle";if(this.settings.length){var r=this.intSettings,u=this,e=e.split(/\s+/).filter(function(a){return a.length>
0});e instanceof Array&&e.forEach(function(a){var b={D:"direction",L:"linePosition",T:"textPosition",A:"alignment",S:"size"},a=a.split(":");b[a[0]]&&(r[b[a[0]]]=a[1]);b[a[0]]in u&&(u[b[a[0]]]=a[1])})}if(this.linePosition.match(/\%/))this.snapToLines=!1;this.getCueAsSource=function(){return String(this.text)};this.getCueAsHTML=function(){var a=document.createDocumentFragment(),b=document.createElement("div");b.innerHTML=String(this.text);Array.prototype.forEach.call(b.childNodes,function(b){a.appendChild(b.cloneNode(!0))});
return a};this.isActive=function(){var a=0;if(this.track instanceof c.TextTrack&&(this.track.mode===c.TextTrack.SHOWING||this.track.mode===c.TextTrack.HIDDEN)&&this.track.readyState===c.TextTrack.LOADED)try{if(a=this.track.videoNode.currentTime,this.startTime<=a&&this.endTime>=a){if(!this.wasActive)this.wasActive=!0,this.onenter();return!0}}catch(b){return!1}if(this.wasActive)this.wasActive=!1,this.onexit();return!1};Object.prototype.__defineGetter__?this.__defineGetter__("active",this.isActive):
Object.defineProperty&&Object.defineProperty(this,"active",{get:this.isActive});this.toString=function(){return"TextTrackCue:"+this.id+"\n"+String(this.text)};this.onenter=function(){};this.onexit=function(){}};c.MediaTrack=function(a,b,f,d,e,n){var l=function(a){return a.filter(function(a){try{var b=document.createElement(a.getAttribute("type").split("/").shift());return!(!b.canPlayType||!b.canPlayType(a.getAttribute("type")).replace(/no/,""))}catch(c){return!1}}).shift().getAttribute("src")};this.onload=
function(){};this.onerror=function(){};this.id=a||"";this.internalMode=this.internalMode=c.TextTrack.OFF;this.mediaElement=null;this.kind=b||"audiodescription";this.label=f||"";this.language=d||"";this.readyState=c.TextTrack.NONE;this.type=n||"x/unknown";this.mediaType=null;this.src="";if(typeof e==="string")this.src=e;else if(e instanceof NodeList)this.src=l(e);if(this.type.match(/^video\//))this.mediaType="video";else if(this.type.match(/^audio\//))this.mediaType="audio";this.getMode=function(){return this.internalMode};
this.setMode=function(a){if([c.TextTrack.OFF,c.TextTrack.HIDDEN,c.TextTrack.SHOWING].indexOf(a)!==-1){if(a!==this.internalMode)this.internalMode=a,a===c.TextTrack.HIDDEN&&!this.mediaElement&&this.buildMediaElement(),a===c.TextTrack.SHOWING&&this.showMediaElement(),(a===c.TextTrack.OFF||a===c.TextTrack.HIDDEN)&&this.hideMediaElement()}else throw Error("Illegal mode value for track.");};Object.prototype.__defineGetter__?(this.__defineGetter__("mode",this.getMode),this.__defineSetter__("mode",this.setMode)):
Object.defineProperty&&Object.defineProperty(this,"mode",{get:this.getMode,set:this.setMode});this.hideMediaElement=function(){if(this.mediaElement&&(this.mediaElement.paused||this.mediaElement.pause(),this.mediaElement instanceof HTMLVideoElement))this.mediaElement.style.display="none"};this.showMediaElement=function(){if(this.mediaElement){if(this.mediaElement.parentNode||document.body.appendChild(this.mediaElement),this.mediaElement instanceof HTMLVideoElement)this.mediaElement.style.display="block"}else this.buildMediaElement(),
document.body.appendChild(this.mediaElement)};this.buildMediaElement=function(){try{if(this.type.match(/^video\//))this.mediaElement=document.createElement("video"),this.mediaElement.className="captionator-mediaElement-"+this.kind,c.styleNode(this.mediaElement,this.kind,this.videoNode);else if(this.type.match(/^audio\//))this.mediaElement=new Audio;this.mediaElement.type=this.type;this.mediaElement.src=this.src;this.mediaElement.load();this.mediaElement.trackObject=this;this.readyState=c.TextTrack.LOADING;
var a=this.mediaElement;this.mediaElement.addEventListener("progress",function(){a.trackObject.readyState=c.TextTrack.LOADING},!1);this.mediaElement.addEventListener("canplaythrough",function(){a.trackObject.readyState=c.TextTrack.LOADED;a.trackObject.onload.call(a.trackObject)},!1);this.mediaElement.addEventListener("error",function(b){a.trackObject.readyState=c.TextTrack.ERROR;a.trackObject.mode=c.TextTrack.OFF;a.trackObject.mediaElement=null;a.trackObject.onerror.call(a.trackObject,b)},!1)}catch(b){this.readyState=
c.TextTrack.ERROR,this.mode=c.TextTrack.OFF,this.mediaElement=null,this.onerror&&this.onerror.apply(this,b)}}};c.CaptionatorCueStructure=function(a,b){var c=this;this.isTimeDependent=!1;this.cueSource=a;this.options=b;this.processedCue=null;this.toString=function(f){if(b.processCueHTML!==!1){var d=function(a,b){if(c.processedCue===null){var e="",h,g;for(h in a)if(h.match(/^\d+$/)&&a.hasOwnProperty(h))if(g=a[h],g instanceof Object&&g.children&&g.children.length)if(g.token==="v")e+='<q data-voice="'+
g.voice.replace(/[\"]/g,"")+"\" class='voice speaker-"+g.voice.replace(/[^a-z0-9]+/ig,"-").toLowerCase()+"' title=\""+g.voice.replace(/[\"]/g,"")+'">'+d(g.children,b+1)+"</q>";else if(g.token==="c")e+="<span class='webvtt-class-span "+g.classes.join(" ")+"'>"+d(g.children,b+1)+"</span>";else if(g.timeIn>0){if(f===null||f===void 0||f>0&&f>=g.timeIn)e+="<span class='webvtt-timestamp-span' data-timestamp='"+g.token+"' data-timestamp-seconds='"+g.timeIn+"'>"+d(g.children,b+1)+"</span>"}else e+=g.rawToken+
d(g.children,b+1)+"</"+g.token+">";else if(g instanceof String||typeof g==="string"||typeof g==="number")e+=g;if(!c.isTimeDependent&&b===0)c.processedCue=e;return e}else return c.processedCue};return d(this,0)}else return a}};c.CaptionatorCueStructure.prototype=[];if(a.exportObjects)window.TextTrack=c.TextTrack,window.TextTrackCueList=c.TextTrackCueList,window.ActiveTextTrackCueList=c.ActiveTextTrackCueList,window.TextTrackCue=c.TextTrackCue,window.MediaTrack=c.MediaTrack;J=!0}[].slice.call(document.getElementsByTagName("video"),
0).forEach(function(a){a.addTextTrack=function(b,f,d,e,n,l,r){var u="subtitles,captions,descriptions,captions,metadata,chapters,karaoke,lyrics,tickertext,audiodescription,commentary,alternate,signlanguage".split(","),y=u.slice(0,7),b=typeof b==="string"?b:"",d=typeof d==="string"?d:"",e=typeof e==="string"?e:"",r=typeof r==="boolean"?r:!1;if(!u.filter(function(a){return f===a?!0:!1}).length)throw c.createDOMException(12,"DOMException 12: SYNTAX_ERR: You must use a valid kind when creating a TimedTextTrack.",
"SYNTAX_ERR");if(y.filter(function(a){return f===a?!0:!1}).length)if(b=new c.TextTrack(b,f,d,e,n,null)){if(!(a.tracks instanceof Array))a.tracks=[];a.tracks.push(b);return b}else return!1;else if(b=new c.MediaTrack(b,f,d,e,n,l,r)){if(!(a.mediaTracks instanceof Array))a.mediaTracks=[];a.mediaTracks.push(b);return b}else return!1}});if(!b||b===!1||b===void 0||b===null)d=[].slice.call(document.getElementsByTagName("video"),0);else if(b instanceof Array)for(e=0;e<b.length;e++)typeof b[e]==="string"?d=
d.concat([].slice.call(document.querySelectorAll(b[e]),0)):b[e].constructor===HTMLVideoElement&&d.push(b[e]);else typeof b==="string"?d=[].slice.call(document.querySelectorAll(b),0):b.constructor===HTMLVideoElement&&d.push(b);if(d.length){for(e=0;e<d.length;e++)c.processVideoElement(d[e],f,a);return!0}else return!1},processVideoElement:function(b,f,a){var d=[],e=navigator.language||navigator.userLanguage;f||e.split("-");a=a instanceof Object?a:{};if(!b.captioned){b._captionatorOptions=a;b.className+=
(b.className.length?" ":"")+"captioned";b.captioned=!0;if(b.id.length===0)b.id=c.generateID();[].slice.call(b.querySelectorAll("track"),0).forEach(function(e){var h=null,h=e.querySelectorAll("source").length>0?e.querySelectorAll("source"):e.getAttribute("src"),h=b.addTextTrack(e.getAttribute("id")||c.generateID(),e.getAttribute("kind"),e.getAttribute("label"),e.getAttribute("srclang").split("-")[0],h,e.getAttribute("type"),e.hasAttribute("default"));e.track=h;h.trackNode=e;h.videoNode=b;d.push(h);
var i=!1;if((h.kind==="subtitles"||h.kind==="captions")&&f===h.language&&a.enableCaptionsByDefault)d.filter(function(a){return(a.kind==="captions"||a.kind==="subtitles")&&f===a.language&&a.mode===c.TextTrack.SHOWING?!0:!1}).length||(i=!0);h.kind==="chapters"&&f===h.language&&(d.filter(function(a){return a.kind==="chapters"&&a.mode===c.TextTrack.SHOWING?!0:!1}).length||(i=!0));h.kind==="descriptions"&&a.enableDescriptionsByDefault===!0&&f===h.language&&(d.filter(function(a){return a.kind==="descriptions"&&
a.mode===c.TextTrack.SHOWING?!0:!1}).length||(i=!0));i===!0&&d.forEach(function(a){if(a.trackNode.hasAttribute("default")&&a.mode===c.TextTrack.SHOWING)a.mode=c.TextTrack.HIDDEN});if(e.hasAttribute("default")&&!d.filter(function(a){return a.trackNode.hasAttribute("default")&&a.trackNode!==e?!0:!1}).length)i=!0,h.internalDefault=!0;if(i===!0)h.mode=c.TextTrack.SHOWING});b.addEventListener("timeupdate",function(b){b=b.target;try{b.tracks.forEach(function(a){a.activeCues.refreshCues.apply(a.activeCues)})}catch(d){}a.renderer instanceof
Function?a.renderer.call(c,b):c.rebuildCaptions(b);c.synchroniseMediaElements(b)},!1);window.addEventListener("resize",function(){b._captionator_dirtyBit=!0;c.rebuildCaptions(b)},!1);b.addEventListener("play",function(){c.synchroniseMediaElements(b)},!1);b.addEventListener("pause",function(){c.synchroniseMediaElements(b)},!1);a.enableHighResolution===!0&&window.setInterval(function(){try{b.tracks.forEach(function(a){a.activeCues.refreshCues.apply(a.activeCues)})}catch(d){}a.renderer instanceof Function?
a.renderer.call(c,b):c.rebuildCaptions(b)},20)}return b},rebuildCaptions:function(b){var f=b.currentTime,a=[],d=!1,e=[],g=[];(b.tracks||[]).forEach(function(b){b.mode===c.TextTrack.SHOWING&&b.readyState===c.TextTrack.LOADED&&(g=[].slice.call(b.activeCues,0),g=g.sort(function(a,b){return a.startTime>b.startTime?-1:1}),a=a.concat(g))});e=a.map(function(a){return a.track.id+"."+a.id+":"+a.text.toString(f).length});if((d=!c.compareArray(e,b._captionator_previousActiveCues))||b._captionator_dirtyBit)b._captionator_dirtyBit=
!1,b._captionator_availableCueArea=null,b._captionator_previousActiveCues=e,c.styleCueCanvas(b),b._containerObject.innerHTML="",a.forEach(function(a){var d=document.createElement("div");d.id=String(a.id).length?a.id:c.generateID();d.className="captionator-cue";d.innerHTML=a.text.toString(f);b._containerObject.appendChild(d);c.styleCue(d,a,b)})},synchroniseMediaElements:function(b){var f=function(a,b){try{b.seeking&&a.pause();if(a.currentTime<b.currentTime-0.5||a.currentTime>b.currentTime+0.5)a.currentTime=
b.currentTime;a.paused&&!b.paused?a.play():!a.paused&&b.paused&&a.pause()}catch(c){}};(b.mediaTracks||[]).forEach(function(a){a.mode===c.TextTrack.SHOWING&&a.readyState>=c.TextTrack.LOADING&&f(a.mediaElement,b)});b.id&&[].slice.call(document.body.querySelectorAll("*[syncMaster="+b.id+"]"),0).forEach(function(a){(a.tagName.toLowerCase()==="video"||a.tagName.toLowerCase()==="audio")&&f(a,b)})},getNodeMetrics:function(b){for(var c=window.getComputedStyle(b,null),a=b,d=b.offsetTop,e=b.offsetLeft,g=b,
h=0,i=0,g=parseInt(c.getPropertyValue("width"),10),h=parseInt(c.getPropertyValue("height"),10);a=a.offsetParent;)d+=a.offsetTop,e+=a.offsetLeft;if(b.hasAttribute("controls"))b=navigator.userAgent.toLowerCase(),b.indexOf("chrome")!==-1?i=32:b.indexOf("opera")!==-1?i=25:b.indexOf("firefox")!==-1?i=28:b.indexOf("ie 9")!==-1||b.indexOf("ipad")!==-1?i=44:b.indexOf("safari")!==-1&&(i=25);else if(b._captionatorOptions)b=b._captionatorOptions,b.controlHeight&&(i=parseInt(b.controlHeight,10));return{left:e,
top:d,width:g,height:h,controlHeight:i}},applyStyles:function(b,c){for(var a in c)({}).hasOwnProperty.call(c,a)&&(b.style[a]=c[a])},checkDirection:function(b){var c=RegExp("^[^\u0591-\u07ff\ufb1d-\ufdfd\ufe70-\ufefc]*[A-Za-z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u02b8\u0300-\u0590\u0800-\u1fff\u2c00-\ufb1c\ufdfe-\ufe6f\ufefd-\uffff]");return RegExp("^[^A-Za-z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u02b8\u0300-\u0590\u0800-\u1fff\u2c00-\ufb1c\ufdfe-\ufe6f\ufefd-\uffff]*[\u0591-\u07ff\ufb1d-\ufdfd\ufe70-\ufefc]").test(b)?
"rtl":c.test(b)?"ltr":""},styleCue:function(b,f,a){var d=0,e=0,g=0,h=0,i,z,p=0,n=0,l,r,u,y,o,t,C=0,q=i=d=0,F=0,G=0,k=0,v,s,w=0,F=a._captionatorOptions||{},j,e=50,d=p=0,e=!0,K=function(a){var b=function(a){return!!a.length},d,e,f,g,h=0,j=function(a){h++;c.applyStyles(a,{display:"block",lineHeight:"auto",height:l+"px",width:t+"px",textAlign:"center"})};for(d in a.childNodes)if(a.childNodes.hasOwnProperty(d))e=a.childNodes[d],e.nodeType===3?(g=document.createDocumentFragment(),f=e.nodeValue,g.appendChild(document.createElement("span")),
g.childNodes[0].innerHTML="<span class='captionator-cue-character'>"+f.split(/(.)/).filter(b).join("</span><span class='captionator-cue-character'>")+"</span>",[].slice.call(g.querySelectorAll("span.captionator-cue-character"),0).forEach(j),e.parentNode.replaceChild(g,e)):a.childNodes[d].nodeType===1&&(h+=K(a.childNodes[d]));return h};j=c.getNodeMetrics(a);if(!a._captionator_availableCueArea)a._captionator_availableCueArea={bottom:j.height-j.controlHeight,right:j.width,top:0,left:0,height:j.height-
j.controlHeight,width:j.width};f.direction==="horizontal"&&(c.applyStyles(b,{width:"auto",position:"static",display:"inline-block",padding:"1em"}),p=parseInt(b.offsetWidth,10),d=Math.floor(p/a._captionator_availableCueArea.width*100),d=d<=100?d:100);p=j.height*(D/100)/96*72;p=p>=A?p:A;l=Math.floor(p/72*96);r=Math.floor(p*E);r=r>B?r:B;t=o=Math.ceil(r/72*96);o*Math.floor(j.height/o)<j.height&&(o=Math.floor(j.height/Math.floor(j.height/o)),r=Math.ceil(o/96*72));o*Math.floor(j.width/o)<j.width&&(t=Math.ceil(j.width/
Math.floor(j.width/o)));u=Math.floor(a._captionator_availableCueArea.height/o);y=Math.floor(a._captionator_availableCueArea.width/t);parseFloat(String(f.size).replace(/[^\d\.]/ig,""))===0?F.sizeCuesByTextBoundingBox===!0?i=d:(i=100,e=!1):(e=!1,i=parseFloat(String(f.size).replace(/[^\d\.]/ig,"")),i=i<=100?i:100);p=f.direction==="horizontal"?Math.floor(j.width*0.01):0;n=f.direction==="horizontal"?0:Math.floor(j.height*0.01);if(f.linePosition==="auto")f.linePosition=f.direction==="horizontal"?u:y;else if(String(f.linePosition).match(/\%/))f.snapToLines=
!1,f.linePosition=parseFloat(String(f.linePosition).replace(/\%/ig,""));f.direction==="horizontal"?(h=o,f.textPosition!=="auto"&&e&&(e=parseFloat(String(f.textPosition).replace(/[^\d\.]/ig,"")),i-e>d?i-=e:i=d),g=f.snapToLines===!0?a._captionator_availableCueArea.width*(i/100):j.width*(i/100),f.textPosition==="auto"?d=(a._captionator_availableCueArea.right-g)/2+a._captionator_availableCueArea.left:(e=parseFloat(String(f.textPosition).replace(/[^\d\.]/ig,"")),d=(a._captionator_availableCueArea.right-
g)*(e/100)+a._captionator_availableCueArea.left),f.snapToLines===!0?e=(u-1)*o+a._captionator_availableCueArea.top:(i=j.controlHeight+o+n*2,e=(j.height-i)*(f.linePosition/100))):(e=a._captionator_availableCueArea.top,d=a._captionator_availableCueArea.right-t,g=t,h=a._captionator_availableCueArea.height*(i/100),d=K(b),i=[].slice.call(b.querySelectorAll("span.captionator-cue-character"),0),C=Math.floor((h-n*2)/l),g=Math.ceil(d/C)*t,q=Math.ceil(d/C),G=(d-C*(q-1))*l,f.snapToLines===!0?d=f.direction===
"vertical-lr"?a._captionator_availableCueArea.left:a._captionator_availableCueArea.right-g:(d=g+p*2,d=f.direction==="vertical-lr"?(j.width-d)*(f.linePosition/100):j.width-d-(j.width-d)*(f.linePosition/100)),f.textPosition==="auto"?e=(a._captionator_availableCueArea.bottom-h)/2+a._captionator_availableCueArea.top:(f.textPosition=parseFloat(String(f.textPosition).replace(/[^\d\.]/ig,"")),e=(a._captionator_availableCueArea.bottom-h)*(f.textPosition/100)+a._captionator_availableCueArea.top),s=v=w=k=0,
i.forEach(function(a){v=f.direction==="vertical-lr"?t*k:g-t*(k+1);f.alignment==="start"||f.alignment!=="start"&&k<q-1?s=w*l+n:f.alignment==="end"?s=w*l-l+(h+n*2-G):f.alignment==="middle"&&(s=(h-n*2-G)/2+w*l);c.applyStyles(a,{position:"absolute",top:s+"px",left:v+"px"});w>=C-1?(w=0,k++):w++}));f.direction==="horizontal"&&(z=c.checkDirection(String(f.text))==="rtl"?{start:"right",middle:"center",end:"left"}[f.alignment]:{start:"left",middle:"center",end:"right"}[f.alignment]);c.applyStyles(b,{position:"absolute",
overflow:"hidden",width:g+"px",height:h+"px",top:e+"px",left:d+"px",padding:n+"px "+p+"px",textAlign:z,backgroundColor:"rgba("+I.join(",")+")",direction:c.checkDirection(String(f.text)),lineHeight:r+"pt",boxSizing:"border-box"});if(f.direction==="vertical"||f.direction==="vertical-lr")d-a._captionator_availableCueArea.left-a._captionator_availableCueArea.left>=a._captionator_availableCueArea.right-(d+g)?a._captionator_availableCueArea.right=d:a._captionator_availableCueArea.left=d+g,a._captionator_availableCueArea.width=
a._captionator_availableCueArea.right-a._captionator_availableCueArea.left;else{if(b.scrollHeight>b.offsetHeight*1.2){if(f.snapToLines){for(z=0;b.scrollHeight>b.offsetHeight*1.2;)h+=o,b.style.height=h+"px",z++;e-=z*o}else h=b.scrollHeight+n,i=j.controlHeight+h+n*2,e=(j.height-i)*(f.linePosition/100),b.style.height=h+"px";b.style.top=e+"px"}if(e-a._captionator_availableCueArea.top-a._captionator_availableCueArea.top>=a._captionator_availableCueArea.bottom-(e+h)&&a._captionator_availableCueArea.bottom>
e)a._captionator_availableCueArea.bottom=e;else if(a._captionator_availableCueArea.top<e+h)a._captionator_availableCueArea.top=e+h;a._captionator_availableCueArea.height=a._captionator_availableCueArea.bottom-a._captionator_availableCueArea.top}if(F.debugMode){var x,m,H=function(){if(!x)a._captionatorDebugCanvas?(x=a._captionatorDebugCanvas,m=a._captionatorDebugContext):(x=document.createElement("canvas"),x.setAttribute("width",j.width),x.setAttribute("height",j.height-j.controlHeight),document.body.appendChild(x),
c.applyStyles(x,{position:"absolute",top:j.top+"px",left:j.left+"px",width:j.width+"px",height:j.height-j.controlHeight+"px",zIndex:3E3}),m=x.getContext("2d"),a._captionatorDebugCanvas=x,a._captionatorDebugContext=m)};H();x.setAttribute("width",j.width);H();m.fillStyle="rgba(100,100,255,0.5)";m.fillRect(a._captionator_availableCueArea.left,a._captionator_availableCueArea.top,a._captionator_availableCueArea.right,a._captionator_availableCueArea.bottom);m.stroke();(function(){var b;H();m.strokeStyle=
"rgba(255,0,0,0.5)";m.lineWidth=1;m.beginPath();for(b=0;b<u;b++)m.moveTo(0.5,b*o+0.5),m.lineTo(j.width,b*o+0.5);m.closePath();m.stroke();m.beginPath();m.strokeStyle="rgba(0,255,0,0.5)";for(b=y;b>=0;b--)m.moveTo(j.width-b*t-0.5,-0.5),m.lineTo(j.width-b*t-0.5,j.height);m.closePath();m.stroke();m.beginPath();m.strokeStyle="rgba(255,255,0,0.5)";for(b=0;b<=y;b++)m.moveTo(b*t+0.5,-0.5),m.lineTo(b*t+0.5,j.height);m.stroke();a.linesDrawn=!0})()}},styleCueCanvas:function(b){var f,a,d=b._captionatorOptions instanceof
Object?b._captionatorOptions:{};if(!(b instanceof HTMLVideoElement))throw Error("Cannot style a cue canvas for a non-video node!");if(b._containerObject)a=b._containerObject,f=a.id;if(a)a.parentNode||document.body.appendChild(a);else{a=document.createElement("div");a.className="captionator-cue-canvas";f=c.generateID();a.id=f;if(d.appendCueCanvasTo){var e=null;if(d.appendCueCanvasTo instanceof HTMLElement)e=d.appendCueCanvasTo;else if(typeof d.appendCueCanvasTo==="string")try{var g=document.querySelectorAll(d.appendCueCanvasTo);
if(g.length>0)e=g[0];else throw null;}catch(h){e=document.body,d.appendCueCanvasTo=!1}else e=document.body,d.appendCueCanvasTo=!1;e.appendChild(a)}else document.body.appendChild(a);b._containerObject=a;a.setAttribute("aria-live","polite");a.setAttribute("aria-atomic","true")}String(b.getAttribute("aria-describedby")).indexOf(f)===-1&&(e=b.hasAttribute("aria-describedby")?b.getAttribute("aria-describedby")+" ":"",b.setAttribute("aria-describedby",e+f));e=c.getNodeMetrics(b);b=e.height*(D/100)/96*72;
b=b>=A?b:A;f=Math.floor(b*E);f=f>B?f:B;c.applyStyles(a,{position:"absolute",overflow:"hidden",zIndex:100,height:e.height-e.controlHeight+"px",width:e.width+"px",top:(d.appendCueCanvasTo?0:e.top)+"px",left:(d.appendCueCanvasTo?0:e.left)+"px",color:"white",fontFamily:"Verdana, Helvetica, Arial, sans-serif",fontSize:b+"pt",lineHeight:f+"pt",boxSizing:"border-box"});if(window.navigator.userAgent.toLowerCase().indexOf("chrome/10")>-1)a.style.backgroundColor="rgba(0,0,0,0.01"+Math.random().toString().replace(".",
"")+")"},parseCaptions:function(b,f){var f=f instanceof Object?f:{},a="",d=[],e="",g=[],h=/^(\d{2})?:?(\d{2}):(\d{2})\.(\d+)\,(\d{2})?:?(\d{2}):(\d{2})\.(\d+)\s*(.*)/,i=/^(\d+)?:?(\d{2}):(\d{2})\.(\d+)\,(\d+)?:?(\d{2}):(\d{2})\.(\d+)\s*(.*)/,z=/^(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)\s+\-\-\>\s+(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)\s*(.*)/,p=/(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)/,n=/^([\d\.]+)\s+\+([\d\.]+)\s*(.*)/,l=/^\[(\d{2})?:?(\d{2})\:(\d{2})\.(\d{2})\]\s*(.*?)$/i,r=/^(DEFAULTS|DEFAULT)\s+\-\-\>\s+(.*)/g,
u=/^(STYLE|STYLES)\s+\-\-\>\s*\n([\s\S]*)/g,y=/^(COMMENT|COMMENTS)\s+\-\-\>\s+(.*)/g;if(b){var o=function(a){var b=new c.CaptionatorCueStructure(a,f),d=[],e,g,h,i=[];h=0;var n=function(a){return!!a.replace(/[^a-z0-9]+/ig,"").length},d=a.split(/(<\/?[^>]+>)/ig).filter(function(a){return!!a.replace(/\s*/ig,"")});h=b;for(e in d)if(d.hasOwnProperty(e))if(g=d[e],g.substr(0,1)==="<")if(g.substr(1,1)==="/"){if(a=g.substr(2).split(/[\s>]+/g)[0],i.length>0){g=0;for(h=i.length-1;h>=0;h--){var o=i[h][i[h].length-
1];g=h;if(o.token===a)break}h=i[g];i=i.slice(0,g)}}else{if(g.substr(1).match(p)||g.match(/^<v\s+[^>]+>/i)||g.match(/^<c[a-z0-9\-\_\.]+>/)||g.match(/^<(b|i|u|ruby|rt)>/)||f.sanitiseCueHTML!==!1){a={token:g.replace(/[<\/>]+/ig,"").split(/[\s\.]+/)[0],rawToken:g,children:[]};if(a.token==="v")a.voice=g.match(/^<v\s*([^>]+)>/i)[1];else if(a.token==="c")a.classes=g.replace(/[<\/>\s]+/ig,"").split(/[\.]+/ig).slice(1).filter(n);else if(g=a.rawToken.match(p))b.isTimeDependent=!0,g=g.slice(1),a.timeIn=parseInt((g[0]||
0)*3600,10)+parseInt((g[1]||0)*60,10)+parseInt(g[2]||0,10)+parseFloat("0."+(g[3]||0));h.push(a);i.push(h);h=a.children}}else f.sanitiseCueHTML!==!1&&(g=g.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\&/g,"&amp;"),f.ignoreWhitespace||(g=g.replace(/\n+/g,"<br />"))),h.push(g);return b},d=b.replace(/\r\n/g,"\n").replace(/\r/g,"\n");l.exec(b)?(d=d.split(/\n+/g),a="LRC"):d=d.split(/\n\n+/g);return d=d.filter(function(b){return b.match(/^WEBVTT(\s*FILE)?/ig)?(a="WebVTT",!1):b.replace(/\s*/ig,"").length?
!0:!1}).map(function(b,d){var q,l,p,k,v="",s;if(s=r.exec(b))return g=s.slice(2).join(""),g=g.split(/\s+/g).filter(function(a){return a&&!!a.length}),null;else if(s=u.exec(b))return e+=s[s.length-1],null;else if(s=y.exec(b))return null;for(q=a==="LRC"?[b.substr(0,b.indexOf("]")),b.substr(b.indexOf("]")+1)]:b.split(/\n/g);!q[0].replace(/\s+/ig,"").length&&q.length>0;)q.shift();for(s=q[0].match(/^\s*[a-z0-9]+\s*$/ig)?String(q.shift().replace(/\s*/ig,"")):d;0<q.length;){var w=q[0];if((k=z.exec(w))||(k=
h.exec(w))||(k=i.exec(w)))k=k.slice(1),l=parseInt((k[0]||0)*3600,10)+parseInt((k[1]||0)*60,10)+parseInt(k[2]||0,10)+parseFloat("0."+(k[3]||0)),p=parseInt((k[4]||0)*3600,10)+parseInt((k[5]||0)*60,10)+parseInt(k[6]||0,10)+parseFloat("0."+(k[7]||0)),k[8]&&(v=k[8]);else if(k=n.exec(w))k=k.slice(1),l=parseFloat(k[0]),p=l+parseFloat(k[1]),k[2]&&(v=k[2]);q=q.slice(0,0).concat(q.slice(1));break}if(!l&&!p)return null;var j=g.reduce(function(a,b){a[b.split(":")[0]]=b.split(":")[1];return a},{}),j=v.split(/\s+/g).filter(function(a){return a&&
!!a.length}).reduce(function(a,b){a[b.split(":")[0]]=b.split(":")[1];return a},j),v="";Object.keys(j).forEach(function(a){v+=v.length?" ":"";v+=a+":"+j[a]});q=f.processCueHTML===!1?q.join("\n"):o(q.join("\n"));l=new c.TextTrackCue(s,l,p,q,v,!1,null);l.styleData=e;return l}).filter(function(a){return a!==null?!0:!1})}else throw Error("Required parameter captionData not supplied.");}};window.captionator=c})();