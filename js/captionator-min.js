/* 
	Captionator 0.2
	Christopher Giffard, 2011
	Share and enjoy

	https://github.com/cgiffard/Captionator
*/

var captionator={createDOMException:function(b,i,h){try{document.querySelectorAll("div/[]")}catch(j){var d=function(f,c,a){this.code=f;this.message=c;this.name=a};d.prototype=j;return new d(b,i,h)}},captionify:function(b,i,h){var j=[],d=0;h=h instanceof Object?h:{};if(HTMLVideoElement){if(typeof document.createElement("video").addTrack==="function")return false}else return false;captionator.TextTrack=function(f,c,a,e){this.onload=function(){};this.onerror=function(){};this.oncuechange=function(){};
this.internalMode=0;this.cues=new captionator.TextTrackCueList(this);this.activeCues=new captionator.ActiveTextTrackCueList(this.cues);this.kind=f||"caption";this.label=c||"";this.language=a||"";this.src=e||"";this.readyState=0;this.getMode=function(){return this.internalMode};this.setMode=function(g){if([0,1,2].indexOf(g)!==-1){if(g!==this.internalMode){this.internalMode=g;this.readyState===0&&this.src.length>0&&g>0&&this.loadTrack(this.src,null);this.readyState===2&&captionator.rebuildCaptions(this.videoNode);
if(g===0||g===1){g="captionator-"+this.videoNode.id+"-"+this.kind+"-"+this.language;(g=document.getElementById(g))&&g.parentNode.removeChild(g)}}}else throw Error("Illegal mode value for track.");};if(Object.prototype.__defineGetter__){this.__defineGetter__("mode",this.getMode);this.__defineSetter__("mode",this.setMode)}else Object.defineProperty&&Object.defineProperty(this,"mode",{get:this.getMode,set:this.setMode});this.loadTrack=function(g,m){var l,n=new XMLHttpRequest;if(this.readyState===2)m instanceof
Function&&m(l);else{this.src=g;this.readyState=1;var k=this;n.open("GET",g,true);n.onreadystatechange=function(){if(n.readyState===4)if(n.status===200){l=captionator.parseCaptions(n.responseText);k.readyState=2;captionator.rebuildCaptions(k.videoNode);k.cues.loadCues(l);k.onload();m instanceof Function&&m.call(k,l)}else k.onerror()};n.send(null)}};this.generateTranscript=function(g){if(typeof g==="string")g=document.querySelectorAll(g)[0];if(typeof g==="object")if(this.readyState===2)this.cues.forEach(function(m){g.innerHTML+=
"<p class='transcriptLine'>"+m.getCueAsSource()+"</p>"});else if(this.readyState===1)this.onload=function(){this.generateTranscript(g)};else this.loadTrack(this.src,function(){this.generateTranscript(g)});else return false};this.addCue=function(){};this.removeCue=function(){}};captionator.TextTrackCueList=function(f){this.track=f instanceof captionator.TextTrack?f:null;this.getCueById=function(c){return this.filter(function(a){return a.id===c})[0]};this.loadCues=function(c){for(var a=0;a<c.length;a++){c[a].track=
this.track;Array.prototype.push.call(this,c[a])}};this.toString=function(){return"[TextTrackCueList]"}};captionator.TextTrackCueList.prototype=[];captionator.ActiveTextTrackCueList=function(f){this.refreshCues=function(){var c=this;this.length=0;f.forEach(function(a){a.active&&c.push(a)})};this.toString=function(){return"[ActiveTextTrackCueList]"};this.refreshCues()};captionator.ActiveTextTrackCueList.prototype=new captionator.TextTrackCueList(null);captionator.TextTrackCue=function(f,c,a,e,g,m,l){this.id=
f;this.track=l instanceof captionator.TextTrack?l:null;this.startTime=parseFloat(c);this.endTime=parseFloat(a);this.text=typeof e==="string"?e:"";this.settings=typeof g==="string"?g:"";this.intSettings={};this.pauseOnExit=!!m;this.direction="horizontal";this.snapToLines=false;this.linePosition="auto";this.size=this.textPosition=0;this.alignment="";if(this.settings.length){var n=this.intSettings;g=g.split(/\s+/).filter(function(k){return k.length>0});g instanceof Array&&g.forEach(function(k){var o=
{D:"verticalText",L:"linePosition",T:"textPosition",A:"textAlignment",S:"textSize"};k=k.split(":");if(o[k[0]])n[o[k[0]]]=k[1]})}this.getCueAsSource=function(){return this.text};this.getCueAsHTML=function(){var k=document.createDocumentFragment(),o=document.createElement("div");o.innerHTML=this.text;Array.prototype.forEach.call(o.childNodes,function(p){k.appendChild(p.cloneNode(true))});return k};this.isActive=function(){var k=0;if(this.track instanceof captionator.TextTrack)if(this.track.mode===2&&
this.track.readyState===2)try{k=this.track.videoNode.currentTime;if(this.startTime<=k&&this.endTime>=k)return true}catch(o){return false}return false};if(Object.prototype.__defineGetter__)this.__defineGetter__("active",this.isActive);else Object.defineProperty&&Object.defineProperty(this,"active",{get:this.isActive});this.onenter=function(){};this.onexit=function(){}};if(h.exportObjects){window.TextTrack=captionator.TextTrack;window.TextTrackCueList=captionator.TextTrackCueList;window.ActiveTextTrackCueList=
captionator.ActiveTextTrackCueList;window.TextTrackCue=captionator.TextTrackCue}[].slice.call(document.getElementsByTagName("video"),0).forEach(function(f){f.addTrack=function(c,a,e,g){a=typeof a==="string"?a:"";e=typeof e==="string"?e:"";if(!["subtitles","captions","descriptions","captions","metadata"].filter(function(m){return c===m?true:false}).length)throw captionator.createDOMException(12,"DOMException 12: SYNTAX_ERR: You must use a valid kind when creating a TimedTextTrack.","SYNTAX_ERR");if(a=
new captionator.TextTrack(c,a,e,g)){if(!(f.tracks instanceof Array))f.tracks=[];f.tracks.push(a);return a}else return false}});if(!b||b===false||b===undefined||b===null)j=[].slice.call(document.getElementsByTagName("video"),0);else if(b instanceof Array)for(d=0;d<b.length;d++)if(typeof b[d]==="string")j=j.concat([].slice.call(document.querySelectorAll(b[d]),0));else b[d].constructor===HTMLVideoElement&&j.push(b[d]);else if(typeof b==="string")j=[].slice.call(document.querySelectorAll(b),0);else b.constructor===
HTMLVideoElement&&j.push(b);if(j.length){for(d=0;d<j.length;d++)captionator.processVideoElement(j[d],i,h);return true}else return false},processVideoElement:function(b,i,h){var j=[],d=navigator.language||navigator.userLanguage;i||d.split("-");h=h instanceof Object?h:{};if(!b.captioned){b.captionatorOptions=h;b.className+=(b.className.length?" ":"")+"captioned";b.captioned=true;if(b.id.length===0){for(d="";d.length<10;)d+=String.fromCharCode(65+Math.floor(Math.random()*26));b.id="captionator"+d}[].slice.call(b.querySelectorAll("track"),
0).forEach(function(f){var c=b.addTrack(f.getAttribute("kind"),f.getAttribute("label"),f.getAttribute("srclang").split("-")[0],f.getAttribute("src"));f.track=c;c.trackNode=f;c.videoNode=b;j.push(c);var a=false;if((c.kind==="subtitles"||c.kind==="captions")&&i===c.language&&h.enableCaptionsByDefault)j.filter(function(e){return(e.kind==="captions"||e.kind==="subtitles")&&i===e.language&&e.mode===2?true:false}).length||(a=true);if(c.kind==="chapters"&&i===c.language)j.filter(function(e){return e.kind===
"chapters"&&e.mode===2?true:false}).length||(a=true);if(c.kind==="descriptions"&&h.enableDescriptionsByDefault===true&&i===c.language)j.filter(function(e){return e.kind==="descriptions"&&e.mode===2?true:false}).length||(a=true);a===true&&j.forEach(function(e){if(e.trackNode.hasAttribute("default")&&e.mode===2)e.mode=1});if(f.hasAttribute("default"))j.filter(function(e){return e.trackNode.hasAttribute("default")&&e.trackNode!==f?true:false}).length||(a=true);if(a===true)c.mode=2});b.addEventListener("timeupdate",
function(f){f=f.target;try{f.tracks.forEach(function(a){a.activeCues.refreshCues()})}catch(c){}h.renderer instanceof Function?h.renderer.call(captionator,f):captionator.rebuildCaptions(f)},false)}return b},rebuildCaptions:function(b){var i="captionator-unset",h=null,j="";b.tracks.forEach(function(d){if(d.mode===2&&d.readyState===2){i="captionator-"+b.id+"-"+d.kind+"-"+d.language;if(h=d.containerObject?d.containerObject:document.getElementById(i))h.parentNode||document.body.appendChild(h);else{h=document.createElement("div");
h.id=i;document.body.appendChild(h);d.containerObject=h;h.setAttribute("aria-live","polite");h.setAttribute("aria-atomic","true");captionator.styleContainer(h,d.kind,d.videoNode)}if(String(b.getAttribute("aria-describedby")).indexOf(i)===-1){var f=b.hasAttribute("aria-describedby")?b.getAttribute("aria-describedby")+" ":"";b.setAttribute("aria-describedby",f+i)}j="";d.activeCues.forEach(function(c){j+='<div class="captionator-cue">'+c.getCueAsSource()+"</div>"});if(String(h.innerHTML)!==j)h.innerHTML=
j;h.style.display=j.length?"block":"none"}})},styleContainer:function(b,i,h){var j=function(e,g){for(var m in g)if({}.hasOwnProperty.call(g,m))e.style[m]=g[m]},d=function(e){var g=window.getComputedStyle(e,null),m=e,l=e.offsetTop,n=e.offsetLeft,k=e,o=0,p=0;k=parseInt(g.getPropertyValue("width"),10);for(o=parseInt(g.getPropertyValue("height"),10);m=m.offsetParent;){l+=m.offsetTop;n+=m.offsetLeft}if(e.hasAttribute("controls")){e=navigator.userAgent.toLowerCase();if(e.indexOf("chrome")!==-1)p=32;else if(e.indexOf("opera")!==
-1)p=25;else if(e.indexOf("firefox")!==-1)p=28;else if(e.indexOf("ie 9")!==-1||e.indexOf("ipad")!==-1)p=44;else if(e.indexOf("safari")!==-1)p=25}return{left:n,top:l,width:k,height:o,controlHeight:p}},f=function(e,g){try{window.addEventListener("resize",function(){var l=d(h);if(g==="bottom"){a=Math.ceil(l.height*0.15<30?30:l.height*0.15);j(e,{width:l.width-40+"px",height:a+"px",left:l.left+"px",top:l.top+l.height-(a+l.controlHeight)+"px",fontSize:(a<=50?a*0.7/96*72:a*0.3/96*72)+"pt",lineHeight:(a<=
50?a/96*72:a/2/96*72)+"pt"})}else{a=l.height*0.1<20?20:l.height*0.1;j(e,{width:l.width-40+"px",minHeight:a+"px",left:l.left+"px",top:l.top+"px",fontSize:(a<=50?a*0.5/96*72:a*0.2/96*72)+"pt",lineHeight:(a<=50?a/96*72:a/2/96*72)+"pt"})}},false)}catch(m){}};if(b instanceof HTMLElement&&h instanceof HTMLVideoElement){var c=d(h),a=0;switch(i){case "caption":case "captions":case "subtitle":a=Math.ceil(c.height*0.15<30?30:c.height*0.15);j(b,{display:"block",position:"absolute",width:c.width-40+"px",height:a+
"px",backgroundColor:"rgba(0,0,0,0.5)",left:c.left+"px",top:c.top+c.height-(a+c.controlHeight)+"px",fontSize:(a<=50?a*0.7/96*72:a*0.3/96*72)+"pt",lineHeight:(a<=50?a/96*72:a/2/96*72)+"pt",color:"white",textShadow:"black 0px 0px 5px",fontFamily:"Helvetica, Arial, sans-serif",fontWeight:"bold",textAlign:"center",paddingLeft:"20px",paddingRight:"20px",overflow:"hidden"});f(b,"bottom");break;case "karaoke":case "lyrics":a=c.height*0.1<20?20:c.height*0.1;j(b,{display:"block",position:"absolute",width:c.width-
40+"px",minHeight:a+"px",backgroundColor:"rgba(0,0,0,0.5)",left:c.left+"px",top:c.top+"px",fontSize:(a<=50?a*0.5/96*72:a*0.2/96*72)+"pt",lineHeight:(a<=50?a/96*72:a/2/96*72)+"pt",color:"gold",fontStyle:"oblique",textShadow:"black 0px 0px 5px",fontFamily:"Helvetica, Arial, sans-serif",fontWeight:"lighter",textAlign:"center",paddingLeft:"20px",paddingRight:"20px",overflow:"hidden"});f(b,"top")}if(b.className.indexOf("captionator-kind")===-1)b.className+=(b.className.length?" ":"")+"captionator-kind-"+
i}},parseCaptions:function(b){if(b)return b.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split(/\n\n/g).filter(function(i){return i.match(/WEBVTT FILE/ig)?false:true}).map(function(i){i=i.split(/\n/g);var h,j,d,f,c,a;if(i[0].match(/^\s*\d+\s*$/ig))a=String(i.shift(0).split(/\s+/).join(""));for(f=0;f<i.length;f++)if(i[f].match(/^\d{2}:\d{2}:\d{2}[\.\,]\d+/)){d=i[f].split(/\s+/ig);h=parseFloat(d[0].split(/[:\,\.]/ig)[0]*60*60+d[0].split(/[:\,\.]/ig)[1]*60+parseInt(d[0].split(/[:\,\.]/ig)[2],10)+"."+parseInt(d[0].split(/[:\,\.]/ig)[3],
10));j=parseFloat(d[2].split(/[:\,\.]/ig)[0]*60*60+d[2].split(/[:\,\.]/ig)[1]*60+parseInt(d[2].split(/[:\,\.]/ig)[2],10)+"."+parseInt(d[2].split(/[:\,\.]/ig)[3],10));if(d.length>=4)c=d.splice(3).join(" ");i=i.slice(0,f).concat(i.slice(f+1));break}i=i.join("\n");return new captionator.TextTrackCue(a,h,j,i,c,false,null)});else throw Error("Required parameter captionData not supplied.");}};